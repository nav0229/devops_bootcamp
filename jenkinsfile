pipeline {
    
    agent {
        docker { image 'jfgarcia268/vlocity_sfdx:core' }
    } 
    environment 
    		{
   		 BRANCH_ENV = "test"
		 API_NUMBER="55"
    		 GIT_CREDENTIALS_ID="d318b3e0-d03b-40d1-a98f-d13fbdc3a0f5"
		 NODE_EXTRA_CA_CERTS=""
		 SERVER_KEY="dxserverkey1"
		 CLIENT_ID="3MVG9SM6_sNwRXqv87fhnI9wtafC.ppK3YSLiD.Ccf55M9wRk1ks54KUGfVYPKsQoNCNfGEuMbU15hPRXgGV4"
		 JWT_KEY="C/certificate/new-cert/server.key"
		 USER_NAME="navdeep.singh@salesforce.com.csgdevops.ndev2"
		 GIT_URL="https://github.com/nav0229/devops_bootcamp.git"
		 SFDX_AUDIENCE_URL="https://test.salesforce.com"
		 SANDBOX_URL="https://csg-devops-bootcamp--ndev2.sandbox.my.salesforce.com"
		 
      		  }
		  

    	stages {
		stage ("Env Info") 
			{
			when {
				anyOf {
					changeRequest target: "test";
					changeRequest target: "uat";
					changeRequest target: "rel_1.0";
					branch "test";
					branch "uat"
					branch "rel_1.0"
				       }
			      }
			stages {
				stage("Fetch Branches") {
					when {
						branch "test";
						branch "uat"
						branch "rel_1.0"
					}
					steps {
						
						sh '''
							git config --add remote.origin.fetch +refs/heads/${BRANCH_ENV}:refs/remotes/origin/${BRANCH_ENV}
							git fetch --no-tags
						'''
						
					}
				}

        
    }
}

	stage("Find delta") {
					steps {
						sh "rm -Rf sf-packager"
						sh "git clone https://github.com/dlively1/sf-packager.git"
						dir ("sf-packager") {
						sh "npm link"}
						//sh "npm install commander -g"
						//sh "git checkout test"
						sh "git checkout rel_1.0"
						//sh "sfpackage test rel_1.0 -p 55 ./Deploy/"
						}
}
	stage("JWT Auth + Validate") {
					steps {			
						
						//sfdx auth:jwt:grant --clientid ${CLIENT_ID} --jwtkeyfile ${JWT_KEY} --username ${USER_NAME} --instanceurl ${SANDBOX_URL}
						sh "sfdx auth:jwt:grant --clientid ${CLIENT_ID} --jwtkeyfile ${JWT_KEY} --username ${USER_NAME} --instanceurl https://login.salesforce.com"
						//sfdx auth:jwt:grant --clientid 3MVG9SM6_sNwRXqv87fhnI9wtafC.ppK3YSLiD.Ccf55M9wRk1ks54KUGfVYPKsQoNCNfGEuMbU15hPRXgGV4 --jwtkeyfile C/certificate/new-cert/server.key --username navdeep.singh@salesforce.com.csgdevops.ndev2 --instanceurl https://csg-devops-bootcamp--ndev2.sandbox.my.salesforce.com
						
						}						
}

}
}
	def tryLogout() {
	sh "sfdx force:auth:logout -u navdeep.singh@salesforce.com.csgdevops.ndev2 -p || true"
			}
